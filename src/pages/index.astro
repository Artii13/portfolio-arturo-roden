---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import Metrics from '@/components/sections/Metrics.astro';
import Manifesto from '@/components/sections/Manifesto.astro';
import TechCarousel from '@/components/sections/TechCarousel.astro';
import Projects from '@/components/sections/Projects.astro';
import Testimonials from '@/components/sections/Testimonials.astro';
import CTA from '@/components/sections/CTA.astro';
import GridBackground from '@/components/effects/GridBackground.astro';
import { links } from '@/data/projects';

// ============================================
// BLUR REVEAL - Función para crear spans animados
// Los delays empiezan en 3.1s para aparecer DESPUÉS del preloader (2.9s)
// ============================================
function createBlurWords(text: string, baseDelay: number, stagger: number): string {
  return text.split(' ').map((word, i) => {
    const delay = (baseDelay + (i * stagger)).toFixed(2);
    return `<span class="blur-word" style="animation-delay: ${delay}s">${word}</span>`;
  }).join(' ');
}

// Delays ajustados: 3.1s base para empezar después del preloader
const labelWords = createBlurWords('Diseño Web · IA · Automatización', 3.1, 0.08);
// Título dividido: "Diseño" + [TYPEWRITER] + "que hace visibles tus resultados."
const titleStart = createBlurWords('Diseño', 3.6, 0.05);
const titleEnd = createBlurWords('que hace visibles tus resultados.', 4.4, 0.05);
const descWords = createBlurWords('Creo sistemas completos que integran diseño estratégico, automatización de procesos y agentes de IA. Todo bajo tu marca, todo conectado, todo funcionando 24/7.', 5.2, 0.02);
---

<Layout>
  <!-- CSS CRÍTICO INLINE - Garantiza que esté en el HTML final -->
  <style is:inline>
    /* ============================================
       BLUR REVEAL ANIMATION
       ============================================ */
    @keyframes blurReveal {
      0% {
        opacity: 0;
        filter: blur(12px);
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        filter: blur(0px);
        transform: translateY(0px);
      }
    }
    
    .blur-word {
      display: inline-block;
      opacity: 0;
      animation-name: blurReveal;
      animation-duration: 0.7s;
      animation-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      animation-fill-mode: forwards;
    }
    
    /* CTA también animado */
    .blur-word-cta {
      display: inline-block;
      opacity: 0;
      animation: blurReveal 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    
    /* ============================================
       HERO TITLE - 2 LÍNEAS FIJAS OBLIGATORIAS
       ============================================ */
    .hero-title {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15em;
      text-align: center;
      font-family: var(--font-display, 'Fraunces', serif);
      font-size: clamp(1.8rem, 4.5vw, 3.5rem);
      font-weight: 400;
      line-height: 1.2;
      color: #1a1a1a;
      margin-bottom: 1.5rem;
      max-width: 100%;
    }
    
    .hero-title-line1,
    .hero-title-line2 {
      display: block;
      width: 100%;
      white-space: nowrap; /* CRÍTICO: Evita que la línea se rompa */
    }
    
    /* Contenedor del typewriter con ancho FIJO */
    .typewriter-wrapper {
      display: inline-block;
      min-width: 420px; /* Ancho basado en "la tecnología invisible" */
      text-align: left;
      vertical-align: baseline;
    }
    
    .typewriter-text {
      display: inline;
    }
    
    .typewriter-cursor {
      display: inline-block;
      margin-left: 2px;
      font-weight: 300;
      color: #1a1a1a;
      animation: cursorBlink 530ms infinite;
    }
    
    /* Responsive: móvil - permitir wrap natural */
    @media (max-width: 640px) {
      .hero-title {
        font-size: clamp(1.4rem, 6vw, 1.8rem);
        gap: 0.3em;
      }
      
      .hero-title-line1,
      .hero-title-line2 {
        white-space: normal; /* En móvil permitir wrap */
      }
      
      .typewriter-wrapper {
        min-width: 180px;
        display: inline-block;
      }
    }
    
    /* Responsive: tablet */
    @media (min-width: 641px) and (max-width: 900px) {
      .hero-title {
        font-size: clamp(1.6rem, 4vw, 2.2rem);
      }
      
      .typewriter-wrapper {
        min-width: 280px;
      }
    }
    
    /* Desktop grande */
    @media (min-width: 1200px) {
      .typewriter-wrapper {
        min-width: 480px;
      }
    }
    
    @keyframes cursorBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    
    /* Ocultar cursor mientras se hace blur reveal */
    .typewriter-text:not(.revealed) + .typewriter-cursor {
      opacity: 0;
      animation: none;
    }
  </style>

  <!-- Grid Background 3D -->
  <GridBackground />
  
  <!-- Main Container -->
  <main id="main-container" class="w-full max-w-[1400px] rounded-[2.5rem] shadow-2xl relative flex flex-col overflow-hidden">
    
    <!-- Sección Hero con fondo claro -->
    <div id="hero-section" class="bg-[#F5F5F3] rounded-t-[2.5rem] relative">
      <Header />
      
      <!-- HERO CONTENT - Directamente aquí, sin componentes -->
      <section class="hero-section relative flex flex-col items-center justify-center min-h-[calc(100vh-120px)] px-6 py-20 z-10 overflow-hidden">
        <!-- Beams Effect -->
        <div class="hero-beams absolute inset-0 z-0 pointer-events-none"></div>
        
        <div class="hero-content flex flex-col items-center text-center max-w-4xl relative z-10">
          
          <!-- Badge Superior -->
          <p class="hero-label" set:html={labelWords}></p>
          
          <!-- Título Principal con Typewriter - 2 líneas fijas -->
          <h1 class="hero-title">
            <span class="hero-title-line1">
              <span set:html={titleStart}></span>
              <span class="typewriter-wrapper">
                <span id="typewriter-text" class="typewriter-text blur-word" style="animation-delay: 3.65s">la tecnología invisible</span>
                <span class="typewriter-cursor">▍</span>
              </span>
            </span>
            <span class="hero-title-line2" set:html={titleEnd}></span>
          </h1>
          
          <!-- Descripción -->
          <p class="hero-description" set:html={descWords}></p>
          
          <!-- CTA Button -->
          <div class="blur-word-cta" style="animation-delay: 5.5s">
            <a 
              href={links.calendar}
              target="_blank"
              rel="noopener noreferrer"
              class="cta-button"
            >
              Agendar ConsultorIA
              <i data-lucide="arrow-up-right" class="w-4 h-4"></i>
            </a>
          </div>
          
        </div>
      </section>
    </div>
    
    <!-- Sección Métricas - Fondo oscuro -->
    <div id="metrics-section" class="bg-[#0a0a0a]">
      <Metrics />
    </div>
    
    <!-- Sección Manifesto - Fondo claro -->
    <div id="manifesto-section" class="bg-[#F5F5F3]">
      <Manifesto />
    </div>
    
    <!-- Sección Tech Carousel - Fondo oscuro -->
    <div id="tech-carousel-section" class="bg-[#0a0a12]">
      <TechCarousel />
    </div>
    
    <!-- Sección Proyectos - Fondo claro -->
    <div id="projects-section" class="bg-[#F5F5F3]">
      <Projects />
    </div>
    
    <!-- Sección Testimonios - Fondo oscuro -->
    <div id="testimonials-section" class="bg-[#0a0a0a]">
      <Testimonials />
    </div>
    
    <!-- Sección CTA y Footer - Fondo claro -->
    <div id="cta-section" class="bg-[#F5F5F3]">
      <CTA />
      <Footer />
    </div>
    
  </main>
</Layout>

<style>
  /* ============================================
     HERO STYLES
     ============================================ */
  
  .hero-section {
    min-height: calc(100vh - 120px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    position: relative;
  }
  
  .hero-content {
    max-width: 900px;
    text-align: center;
    padding: 0 2rem;
  }
  
  @media (min-width: 1024px) {
    .hero-content {
      max-width: 1000px;
    }
  }
  
  .hero-label {
    font-size: 0.65rem;
    font-family: var(--font-body);
    font-weight: 400;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: #888;
    margin-bottom: 2rem;
  }
  
  /* .hero-title está definido en <style is:inline> para 2 líneas fijas */
  
  .hero-description {
    font-family: var(--font-body);
    font-size: clamp(1rem, 2vw, 1.25rem);
    font-weight: 300;
    line-height: 1.7;
    color: #666;
    max-width: 600px;
    margin: 1.5rem auto 2rem;
  }
  
  .cta-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #1a1a1a, #333);
    color: white;
    font-family: var(--font-body);
    font-weight: 500;
    font-size: 0.875rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    text-decoration: none;
    border-radius: 100px;
    white-space: nowrap;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  }
  
  .cta-button:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  }
  
  /* ============================================
     BEAMS EFFECT
     ============================================ */
  
  .hero-beams {
    opacity: 0.15;
  }
  
  .hero-beams::before,
  .hero-beams::after {
    content: '';
    position: absolute;
    width: 200%;
    height: 200%;
    background: linear-gradient(
      45deg,
      transparent 0%,
      rgba(255, 107, 53, 0.1) 25%,
      rgba(247, 147, 26, 0.15) 50%,
      rgba(255, 179, 71, 0.1) 75%,
      transparent 100%
    );
    animation: beam-rotate 18s ease-in-out infinite;
  }
  
  .hero-beams::before {
    top: -50%;
    left: -50%;
    transform-origin: center center;
  }
  
  .hero-beams::after {
    bottom: -50%;
    right: -50%;
    transform-origin: center center;
    animation-delay: -9s;
    background: linear-gradient(
      -45deg,
      transparent 0%,
      rgba(255, 107, 53, 0.1) 25%,
      rgba(247, 147, 26, 0.15) 50%,
      rgba(255, 179, 71, 0.1) 75%,
      transparent 100%
    );
  }
  
  @keyframes beam-rotate {
    0%, 100% {
      transform: rotate(0deg) scale(1);
      opacity: 0.1;
    }
    25% {
      transform: rotate(5deg) scale(1.1);
      opacity: 0.2;
    }
    50% {
      transform: rotate(0deg) scale(1);
      opacity: 0.15;
    }
    75% {
      transform: rotate(-5deg) scale(1.1);
      opacity: 0.2;
    }
  }
</style>

<script>
  // Smooth scroll para enlaces internos
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
      anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const href = (e.currentTarget as HTMLAnchorElement).getAttribute('href');
        if (!href) return;
        
        const target = document.querySelector(href);
        if (!target) return;
        
        // Usar Lenis si existe, sino scroll nativo
        const win = window as typeof window & { 
          lenis?: { 
            scrollTo: (target: Element, options?: { offset?: number; duration?: number }) => void 
          } 
        };
        
        if (win.lenis) {
          win.lenis.scrollTo(target, { offset: 0, duration: 1.2 });
        } else {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  });
</script>

<script>
  // ============================================
  // TYPEWRITER EFFECT - Premium animated text
  // ============================================
  (function() {
    const phrases = [
      'la tecnología invisible',
      'tu Ecosistema Digital',
      'tu Web',
      'tu Agente de IA'
    ];
    
    const config = {
      typingSpeed: 65,        // ms por carácter al escribir
      deletingSpeed: 45,      // ms por carácter al borrar
      pauseAfterTyping: 1000, // pausa después de escribir
      pauseAfterDeleting: 300, // pausa después de borrar
      startDelay: 5500        // delay inicial (después del blur reveal del título)
    };
    
    let currentPhraseIndex = 0;
    let currentCharIndex = phrases[0].length;
    let isDeleting = false;
    let hasStarted = false;
    
    const typewriterElement = document.getElementById('typewriter-text') as HTMLElement | null;
    if (!typewriterElement) return;
    
    // Marcar como revealed después del blur reveal
    setTimeout(() => {
      typewriterElement.classList.add('revealed');
    }, 4350); // 3.65s delay + 0.7s duration
    
    function type() {
      if (!hasStarted || !typewriterElement) return;
      
      const currentPhrase = phrases[currentPhraseIndex];
      
      if (!isDeleting) {
        // Escribiendo
        if (currentCharIndex < currentPhrase.length) {
          typewriterElement.textContent = currentPhrase.slice(0, currentCharIndex + 1);
          currentCharIndex++;
          setTimeout(type, config.typingSpeed);
        } else {
          // Terminó de escribir, pausar y luego borrar
          setTimeout(() => {
            isDeleting = true;
            type();
          }, config.pauseAfterTyping);
        }
      } else {
        // Borrando
        if (currentCharIndex > 0) {
          typewriterElement.textContent = currentPhrase.slice(0, currentCharIndex - 1);
          currentCharIndex--;
          setTimeout(type, config.deletingSpeed);
        } else {
          // Terminó de borrar, pasar a siguiente frase
          isDeleting = false;
          currentPhraseIndex = (currentPhraseIndex + 1) % phrases.length;
          setTimeout(type, config.pauseAfterDeleting);
        }
      }
    }
    
    // Iniciar después del delay
    setTimeout(() => {
      hasStarted = true;
      // Empezar borrando la primera frase
      isDeleting = true;
      type();
    }, config.startDelay);
  })();
</script>
